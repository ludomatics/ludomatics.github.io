#!/bin/bash

# Build script to generate HTML files from YAML exam files
# Converts YAML to JSON (temporary), embeds data in HTML, then cleans up
echo "ğŸš€ Building exam HTML files..."

# Check if source directory exists
if [ ! -d "source" ]; then
    echo "âŒ No source directory found"
    echo "ğŸ’¡ Create the 'source' directory and add YAML files to get started"
    exit 1
fi

# Check if templates exist
if [ ! -f "templates/exam-template.html" ]; then
    echo "âŒ No templates/exam-template.html found to use as template"
    echo "ğŸ’¡ Make sure the templates directory contains exam-template.html"
    exit 1
fi

if [ ! -f "templates/landing-template.html" ]; then
    echo "âŒ No templates/landing-template.html found to use as template"
    echo "ğŸ’¡ Make sure the templates directory contains landing-template.html"
    exit 1
fi

# Clean up old generated files (but keep JSON files)
echo "ğŸ§¹ Cleaning up old generated files..."
rm -f exams/*.html

# Function to generate landing page
generateLandingPage() {
    # Read the landing template
    local template=$(cat templates/landing-template.html)
    
    # Initialize variables
    local exam_sections=""
    
    # Categorize exams
    local universidad_exams=""
    local bachillerato_exams=""
    local other_exams=""
    
    # Process each JSON file to build exam sections (including converted YAML files)
    for json_file in exams/*.json; do
        if [ -f "$json_file" ]; then
            local exam_name=$(basename "$json_file" .json)
            
            # Read exam title from JSON
            local title=$(grep '"title"' "$json_file" | head -1 | sed 's/.*"title": *"\([^"]*\)".*/\1/')
            
            # Create exam card HTML
            local exam_card="
                <div class='exam-card'>
                    <h3>$title</h3>
                    <a href='exams/$exam_name.html' class='btn'>Comenzar Examen</a>
                </div>"
            
            # Categorize based on filename
            if [[ "$exam_name" == *"universidad"* ]]; then
                universidad_exams="$universidad_exams$exam_card"
            elif [[ "$exam_name" == *"bachillerato"* ]] || [[ "$exam_name" == *"comipems"* ]]; then
                bachillerato_exams="$bachillerato_exams$exam_card"
            else
                other_exams="$other_exams$exam_card"
            fi
        fi
    done
    
    # Build exam sections HTML
    if [ -n "$universidad_exams" ]; then
        exam_sections="$exam_sections
        <div class='category'>
            <h2>ğŸ“ ExÃ¡menes Universidad</h2>
            <div class='exam-grid'>
                $universidad_exams
            </div>
        </div>"
    fi
    
    if [ -n "$bachillerato_exams" ]; then
        exam_sections="$exam_sections
        <div class='category'>
            <h2>ğŸ« ExÃ¡menes Bachillerato</h2>
            <div class='exam-grid'>
                $bachillerato_exams
            </div>
        </div>"
    fi
    
    if [ -n "$other_exams" ]; then
        exam_sections="$exam_sections
        <div class='category'>
            <h2>ğŸ“ Otros ExÃ¡menes</h2>
            <div class='exam-grid'>
                $other_exams
            </div>
        </div>"
    fi
    
    # Replace placeholders in template using a file-based approach
    # Write template to temporary file
    echo "$template" > temp_template.html
    
    # Replace placeholders one by one
    
    # Fix CSS path for the generated index.html (change ../index.css to index.css)
    sed -i.bak "s|../index.css|index.css|g" temp_template.html
    
    # For exam sections, we need to handle multiline content carefully
    # Create a temporary file with the exam sections
    echo "$exam_sections" > temp_exam_sections.html
    
    # Use awk to replace the placeholder with file content
    awk '/{{EXAM_SECTIONS}}/ { system("cat temp_exam_sections.html"); next } { print }' temp_template.html > temp_final.html
    
    local generated_content=$(cat temp_final.html)
    
    # Clean up temporary files
    rm temp_template.html temp_template.html.bak temp_exam_sections.html temp_final.html
    
    # Add auto-generated comment at the top
    cat > index.html << EOF
<!-- AUTO-GENERATED FILE - DO NOT MODIFY MANUALLY -->
<!-- Generated by build-exams.sh script -->
<!-- Landing page with all available exams -->

$generated_content
EOF
    
    echo "âœ… Generated: index.html (landing page)"
}

# Counter for generated files
generated_count=0

# First, convert YAML files to JSON (if any)
echo "ğŸ”„ Converting YAML files to JSON..."

# Check if required Python scripts exist
if [ ! -f "yaml_to_json.py" ]; then
    echo "âŒ Error: yaml_to_json.py not found"
    exit 1
fi

if [ ! -f "embed_exam_data.py" ]; then
    echo "âŒ Error: embed_exam_data.py not found"
    exit 1
fi

for yaml_file in source/*.yaml; do
    if [ -f "$yaml_file" ]; then
        echo "ğŸ“ Converting: $(basename "$yaml_file")"
        python3 yaml_to_json.py "$yaml_file"
        if [ $? -ne 0 ]; then
            echo "âŒ Error converting $(basename "$yaml_file")"
            exit 1
        fi
    fi
done

# Process each JSON file in exams directory (including converted ones)
for json_file in exams/*.json; do
    if [ -f "$json_file" ]; then
        # Extract filename without path and extension
        exam_name=$(basename "$json_file" .json)
        
        # Create HTML filename in exams directory
        html_file="exams/${exam_name}.html"
        
        echo "ğŸ“ Processing: $exam_name"
        
        # Copy template to new file
        cp templates/exam-template.html "$html_file"
        
        # Add auto-generated comment at the top
        sed -i.bak "1i\\
<!-- AUTO-GENERATED FILE - DO NOT MODIFY MANUALLY -->\\
<!-- Generated by build-exams.sh script -->\\
<!-- Source: $exam_name.yaml -->\\
" "$html_file"

        # Embed exam data directly in the HTML file
        python3 embed_exam_data.py "$json_file" "$html_file"
        if [ $? -ne 0 ]; then
            echo "âŒ Error embedding exam data in $(basename "$html_file")"
            exit 1
        fi
        
        # Remove backup file
        rm "${html_file}.bak"
        
        echo "âœ… Generated: $html_file"
        ((generated_count++))
    fi
done

# Generate landing page
echo "ğŸ“ Generating landing page..."
generateLandingPage

# Clean up intermediate JSON files that were converted from YAML
echo "ğŸ§¹ Cleaning up intermediate JSON files..."
for yaml_file in source/*.yaml; do
    if [ -f "$yaml_file" ]; then
        base_name=$(basename "$yaml_file" .yaml)
        json_file="exams/${base_name}.json"
        if [ -f "$json_file" ]; then
            echo "ğŸ—‘ï¸  Removing intermediate: $json_file"
            rm "$json_file"
        fi
    fi
done

echo ""
echo "ğŸ‰ Build completed!"
echo "ğŸ“„ Generated $generated_count HTML files:"
ls -la exams/*.html
echo "ğŸ“„ Generated landing page: index.html" 
